import sys
import time
from torch.nn import functional as F

import numpy as np
import pandas
import torch
from torchvision import transforms
from torch.utils.data import DataLoader
from torchreid import metrics
from torchreid import utils
from common import get_model_resgcn
from utils import AverageMeter
from datasets import dataset_factory
from datasets.augmentation import ShuffleSequence, SelectSequenceCenter, ToTensor, MultiInput
from datasets.graph import Graph

def _feature_extraction(data_loader):
        f_,pid_,camids_=[],[],[]
        for (v,k) in data_loader:
            pid_.append(v[0])
            camids_.append(v[1])
            features=k
            f_.append(features)
        pids_=np.asarray(pid_)
        camids_=np.asarray(camids_)
        f_=np.asarray(f_)
        return f_,pids_,camids_

def _writecsv(lg, fg , lq, fq , seq):
    fg=pandas.DataFrame(fg)
    lg=pandas.DataFrame(lg)
    lg=lg.transpose()
    wg=pandas.concat((fg,lg),axis=1)
    ng=f"gallery_mars_"+str(seq)+".csv"
    wg.to_csv(ng,index=False)
    fq=pandas.DataFrame(fq)
    lq=pandas.DataFrame(lq)
    lq=lq.transpose()
    wq=pandas.concat((fq,lq),axis=1)
    nq=f"query_mars_"+str(seq)+".csv"
    wq.to_csv(nq,index=False)
    print("Finsh writing ........")
def _writecsv1(lg, fg , lq, fq ):
    fg=pandas.DataFrame(fg)
    lg=pandas.DataFrame(lg)
    lg=lg.transpose()
    wg=pandas.concat((fg,lg),axis=1)
    ng=f"gallery_mars_60.csv"
    wg.to_csv(ng,index=False)
    fq=pandas.DataFrame(fq)
    lq=pandas.DataFrame(lq)
    lq=lq.transpose()
    wq=pandas.concat((fq,lq),axis=1)
    nq=f"query_mars_60.csv"
    wq.to_csv(nq,index=False)
    print("Finsh writing ........")
def compute_distance_matrix(input1, input2, dist_metric='euclidean'):
    """A wrapper function for computing distance matrix.

    Args:
        input1 (torch.Tensor): 2-D feature matrix.
        input2 (torch.Tensor): 2-D feature matrix.
        metric (str, optional): "euclidean" or "cosine".
            Default is "euclidean".

    Returns:
        torch.Tensor: distance matrix.

    Examples::
       >>> from torchreid import metrics
       >>> input1 = torch.rand(10, 2048)
       >>> input2 = torch.rand(100, 2048)
       >>> distmat = metrics.compute_distance_matrix(input1, input2)
       >>> distmat.size() # (10, 100)
    """
    # check input
    assert isinstance(input1, torch.Tensor)
    assert isinstance(input2, torch.Tensor)
    assert input1.dim() == 2, 'Expected 2-D tensor, but got {}-D'.format(
        input1.dim()
    )
    assert input2.dim() == 2, 'Expected 2-D tensor, but got {}-D'.format(
        input2.dim()
    )
    assert input1.size(1) == input2.size(1)

    if dist_metric == 'euclidean':
        distmat = euclidean_squared_distance(input1, input2)
    elif dist_metric == 'cosine':
        distmat = cosine_distance(input1, input2)
    else:
        raise ValueError(
            'Unknown distance metric: {}. '
            'Please choose either "euclidean" or "cosine"'.format(dist_metric)
        )

    return distmat


def euclidean_squared_distance(input1, input2):
    """Computes euclidean squared distance.

    Args:
        input1 (torch.Tensor): 2-D feature matrix.
        input2 (torch.Tensor): 2-D feature matrix.

    Returns:
        torch.Tensor: distance matrix.
    """
    m, n = input1.size(0), input2.size(0)
    mat1 = torch.pow(input1, 2).sum(dim=1, keepdim=True).expand(m, n)
    mat2 = torch.pow(input2, 2).sum(dim=1, keepdim=True).expand(n, m).t()
    distmat = mat1 + mat2
    distmat.addmm_(input1, input2.t(), beta=1, alpha=-2)
    return distmat


def cosine_distance(input1, input2):
    """Computes cosine distance.

    Args:
        input1 (torch.Tensor): 2-D feature matrix.
        input2 (torch.Tensor): 2-D feature matrix.

    Returns:
        torch.Tensor: distance matrix.
    """
    input1_normed = F.normalize(input1, p=2, dim=1)
    input2_normed = F.normalize(input2, p=2, dim=1)
    distmat = 1 - torch.mm(input1_normed, input2_normed.t())
    return distmat
def eval_market1501(distmat, q_pids, g_pids, q_camids, g_camids, max_rank=50):
    num_q, num_g = distmat.shape
    if num_g < max_rank:
        max_rank = num_g
        print("Note: number of gallery samples is quite small, got {}".format(num_g))
    indices = np.argsort(distmat, axis=1)
    matches = (g_pids[indices] == q_pids[:, np.newaxis]).astype(np.int32)

    # compute cmc curve for each query
    all_cmc = []
    all_AP = []
    num_valid_q = 0.
    for q_idx in range(num_q):
        # get query pid and camid
        q_pid = q_pids[q_idx]
        q_camid = q_camids[q_idx]

        # remove gallery samples that have the same pid and camid with query
        order = indices[q_idx]
        remove = (g_pids[order] == q_pid) & (g_camids[order] == q_camid)
        keep = np.invert(remove)

        # compute cmc curve
        orig_cmc = matches[q_idx][keep] # binary vector, positions with value 1 are correct matches
        if not np.any(orig_cmc):
            # this condition is true when query identity does not appear in gallery
            continue

        cmc = orig_cmc.cumsum()
        cmc[cmc > 1] = 1

        all_cmc.append(cmc[:max_rank])
        num_valid_q += 1.

        # compute average precision
        # reference: https://en.wikipedia.org/wiki/Evaluation_measures_(information_retrieval)#Average_precision
        num_rel = orig_cmc.sum()
        tmp_cmc = orig_cmc.cumsum()
        tmp_cmc = [x / (i+1.) for i, x in enumerate(tmp_cmc)]
        tmp_cmc = np.asarray(tmp_cmc) * orig_cmc
        AP = tmp_cmc.sum() / num_rel
        all_AP.append(AP)

    assert num_valid_q > 0, "Error: all query identities do not appear in gallery"

    all_cmc = np.asarray(all_cmc).astype(np.float32)
    all_cmc = all_cmc.sum(0) / num_valid_q
    mAP = np.mean(all_AP)

    return all_cmc, mAP
def _feature_extraction2(data_loader):
        f_,pid_,camids_,trklets_=[],[],[],[]
        for (v,k) in data_loader:
            pid_.append(v[0])
            camids_.append(v[1])
            trklets_.append(v[2])
            features=k
            f_.append(features)
        pids_=np.asarray(pid_)
        camids_=np.asarray(camids_)
        trklets_=np.asarray(trklets_)
        f_=np.asarray(f_)
        return f_,pids_,camids_,trklets_ 
def _evaluate_mars(embeddings,normalize_feature=True,ranks=[1, 5, 10, 20,30,50],dist_metric='euclidean',visrank=False,rerank=False):
    """ MARS.

    Reference:
        Zheng et al. MARS: A Video Benchmark for Large-Scale Person Re-identification. ECCV 2016.

    URL: `<http://www.liangzheng.com.cn/Project/project_mars.html>`_
    
    Dataset statistics:
        - identities: 1261.
        - tracklets: 8298 (train) + 1980 (query) + 9330 (gallery).
        - cameras: 6.

    Args:
        embeddings (_type_): _description_
        
    trainbbox:625 
    testbbox:636 (gallery+query)
    """
    
    J2=[(2, 1, 12), (2, 2, 21), (2, 3, 30), (2, 6, 37), (4, 1, 2), (4, 2, 4), (4, 5, 8), (6, 1, 1), (6, 2, 2), (8, 1, 3), (8, 3, 4), (8, 6, 5), (10, 1, 2), (10, 5, 4), (16, 1, 6), (16, 2, 7), (16, 3, 14), (16, 5, 15), (16, 6, 22), (18, 1, 3), (18, 2, 5), (18, 3, 6), (18, 4, 9), (18, 5, 12), (22, 1, 3), (22, 2, 4), (22, 3, 12), (22, 4, 17), (22, 5, 26), (22, 6, 38), (24, 1, 1), (24, 2, 3), (24, 3, 6), (24, 6, 7), (26, 1, 2), (26, 2, 6), (26, 3, 7), (26, 6, 8), (28, 1, 1), (28, 2, 2), (28, 3, 3), (28, 6, 6), (32, 3, 3), (32, 5, 4), (32, 6, 8), (34, 1, 1), (34, 2, 7), (34, 3, 11), (34, 4, 14), (34, 5, 20), (34, 6, 25), (36, 1, 2), (36, 2, 7), (36, 3, 9), (36, 6, 13), (44, 1, 2), (44, 2, 3), (44, 4, 6), (44, 5, 8), (46, 4, 3), (46, 5, 7), (48, 1, 6), (48, 2, 9), (48, 3, 12), (48, 4, 14), (48, 5, 24), (48, 6, 26), (50, 2, 4), (50, 3, 5), (50, 6, 7), (52, 2, 1), (52, 3, 2), (52, 6, 6), (60, 1, 3), (60, 2, 5), (60, 3, 7), (60, 4, 14), (60, 5, 17), (60, 6, 21), (62, 1, 1), (62, 3, 4), (62, 5, 5), (62, 6, 11), (64, 2, 1), (64, 3, 2), (64, 6, 6), (66, 1, 1), (66, 2, 3), (66, 3, 6), (66, 5, 8), (66, 6, 12), (68, 3, 1), (68, 6, 21), (72, 1, 2), (72, 2, 7), (72, 4, 8), (72, 5, 9), (76, 1, 11), (76, 3, 14), (76, 4, 16), (76, 5, 23), (76, 6, 28), (78, 1, 4), (78, 2, 10), (78, 3, 12), (78, 6, 17), (80, 1, 2), (80, 2, 3), (80, 3, 4), (80, 4, 9), (80, 5, 10), (80, 6, 13), (82, 1, 5), (82, 5, 6), (92, 1, 19), (92, 2, 25), (92, 3, 35), (92, 4, 40), (92, 5, 64), (92, 6, 70), (94, 1, 5), (94, 3, 17), (94, 5, 28), (94, 6, 36), (96, 1, 5), (96, 2, 11), (96, 3, 14), (96, 6, 20), (100, 1, 12), (100, 2, 20), (100, 3, 22), (100, 4, 31), (100, 5, 39), (100, 6, 40), (104, 1, 7), (104, 2, 10), (104, 3, 17), (104, 4, 18), (104, 5, 21), (104, 6, 25), (106, 1, 4), (106, 2, 7), (106, 3, 10), (106, 4, 13), (106, 5, 15), (110, 1, 1), (110, 2, 5), (110, 3, 8), (110, 4, 10), (110, 5, 17), (110, 6, 23), (112, 1, 7), (112, 2, 12), (112, 3, 15), (112, 4, 18), (112, 5, 21), (112, 6, 25), (116, 1, 5), (116, 3, 7), (116, 4, 10), (116, 5, 13), (116, 6, 20), (118, 1, 1), (118, 2, 4), (120, 1, 1), (120, 2, 10), (120, 3, 11), (120, 6, 16), (128, 1, 2), (128, 5, 7), (130, 1, 2), (130, 5, 5), (132, 1, 10), (132, 2, 25), (132, 3, 32), (132, 5, 34), (132, 6, 49), (136, 1, 2), (136, 2, 5), (136, 3, 6), (136, 4, 9), (136, 5, 10), (142, 1, 5), (142, 2, 10), (142, 4, 12), (142, 5, 14), (144, 1, 3), (144, 2, 10), (144, 3, 13), (144, 6, 16), (146, 1, 4), (146, 2, 16), (146, 3, 21), (146, 5, 24), (146, 6, 30), (148, 1, 7), (148, 2, 9), (148, 3, 17), (148, 4, 22), (148, 5, 29), (148, 6, 35), (150, 1, 1), (150, 4, 2), (150, 5, 4), (152, 1, 1), (152, 4, 2), (156, 1, 5), (156, 2, 7), (156, 3, 22), (156, 4, 27), (156, 5, 41), (156, 6, 50), (158, 1, 4), (158, 2, 17), (158, 3, 21), (158, 5, 26), (158, 6, 37), (160, 2, 2), (160, 3, 3), (160, 6, 9), (162, 4, 2), (162, 5, 3), (170, 2, 2), (170, 3, 3), (170, 6, 6), (172, 1, 1), (172, 2, 3), (174, 1, 10), (174, 2, 22), (174, 3, 46), (174, 5, 51), (174, 6, 72), (176, 1, 4), (176, 2, 6), (176, 3, 10), (176, 5, 13), (176, 6, 16), (178, 1, 4), (178, 2, 6), (178, 3, 9), (178, 6, 16), (182, 1, 1), (182, 2, 2), (182, 3, 3), (182, 4, 8), (182, 5, 11), (182, 6, 12), (184, 1, 6), (184, 2, 12), (184, 4, 21), (184, 5, 25), (186, 1, 3), (186, 2, 5), (186, 3, 7), (186, 6, 14), (188, 1, 12), (188, 2, 17), (188, 4, 29), (188, 5, 39), (192, 1, 6), (192, 2, 17), (192, 3, 20), (192, 6, 28), (194, 1, 9), (194, 2, 14), (194, 3, 20), (194, 6, 26), (196, 2, 3), (196, 3, 4), (196, 6, 6), (198, 1, 5), (198, 2, 16), (198, 3, 20), (198, 5, 25), (198, 6, 29), (200, 1, 3), (200, 2, 5), (200, 3, 9), (200, 4, 12), (200, 5, 13), (200, 6, 14), (202, 1, 3), (202, 2, 5), (202, 4, 13), (202, 5, 19), (204, 1, 2), (204, 2, 8), (204, 3, 11), (204, 4, 12), (204, 5, 13), (204, 6, 15), (206, 1, 4), (206, 2, 14), (206, 3, 16), (206, 6, 23), (208, 1, 7), (208, 2, 16), (208, 3, 30), (208, 4, 31), (208, 5, 36), (208, 6, 44), (210, 1, 4), (210, 2, 5), (210, 3, 13), (210, 5, 19), (210, 6, 25), (216, 1, 8), (216, 2, 9), (216, 3, 15), (216, 4, 21), (216, 5, 28), (218, 1, 4), (218, 2, 17), (218, 3, 22), (218, 6, 25), (220, 1, 9), (220, 2, 11), (220, 3, 15), (220, 5, 16), (220, 6, 28), (222, 1, 5), (222, 2, 7), (222, 3, 12), (222, 4, 14), (222, 5, 25), (222, 6, 29), (224, 1, 5), (224, 2, 10), (224, 3, 15), (224, 5, 16), (224, 6, 27), (226, 1, 5), (226, 2, 7), (226, 3, 14), (226, 4, 17), (226, 5, 21), (226, 6, 25), (228, 1, 5), (228, 2, 23), (228, 3, 43), (228, 6, 64), (230, 1, 2), (230, 2, 6), (230, 3, 12), (230, 5, 15), (230, 6, 19), (232, 1, 7), (232, 2, 13), (232, 3, 23), (232, 5, 31), (232, 6, 45), (236, 2, 2), (236, 3, 4), (236, 6, 6), (238, 1, 2), (238, 2, 5), (240, 1, 4), (240, 2, 10), (240, 3, 11), (240, 4, 15), (240, 5, 16), (240, 6, 19), (242, 1, 3), (242, 3, 16), (242, 5, 21), (242, 6, 27), (244, 1, 5), (244, 2, 8), (244, 3, 11), (244, 6, 13), (248, 1, 2), (248, 2, 7), (248, 3, 8), (252, 1, 1), (252, 3, 4), (252, 5, 5), (252, 6, 13), (254, 1, 3), (254, 2, 9), (254, 3, 11), (254, 6, 14), (256, 1, 3), (256, 2, 5), (256, 3, 12), (256, 6, 16), (258, 2, 3), (258, 6, 4), (260, 1, 5), (260, 2, 12), (260, 3, 23), (260, 5, 44), (260, 6, 50), (262, 1, 3), (262, 2, 8), (262, 4, 14), (262, 5, 17), (264, 1, 5), (264, 2, 11), (264, 3, 14), (264, 4, 17), (264, 5, 22), (264, 6, 31), (266, 1, 2), (266, 2, 7), (266, 3, 10), (266, 5, 11), (266, 6, 18), (268, 3, 3), (268, 4, 6), (268, 5, 7), (268, 6, 9), (270, 1, 16), (270, 2, 18), (270, 3, 29), (270, 5, 43), (270, 6, 49), (272, 1, 2), (272, 2, 5), (272, 3, 82), (272, 5, 112), (272, 6, 209), (274, 1, 7), (274, 2, 11), (274, 3, 18), (274, 5, 20), (274, 6, 26), (276, 1, 4), (276, 5, 6), (278, 1, 2), (278, 2, 5), (278, 3, 6), (278, 4, 12), (278, 5, 15), (280, 1, 2), (280, 2, 5), (280, 3, 7), (280, 6, 13), (282, 2, 5), (282, 3, 6), (282, 6, 7), (284, 1, 5), (284, 2, 6), (284, 3, 9), (284, 6, 15), (286, 1, 6), (286, 2, 11), (286, 3, 15), (286, 6, 20), (288, 1, 4), (288, 2, 9), (288, 3, 14), (288, 5, 15), (288, 6, 20), (290, 1, 3), (290, 2, 8), (290, 3, 12), (290, 4, 14), (290, 5, 15), (290, 6, 18), (292, 1, 2), (292, 2, 4), (292, 3, 6), (292, 4, 8), (292, 5, 11), (292, 6, 12), (294, 1, 2), (294, 2, 3), (294, 3, 6), (294, 5, 7), (294, 6, 12), (296, 1, 1), (296, 3, 7), (296, 5, 13), (296, 6, 20), (298, 3, 4), (298, 4, 7), (298, 5, 10), (298, 6, 13), (300, 1, 1), (300, 3, 6), (300, 5, 10), (300, 6, 21), (302, 1, 3), (302, 2, 6), (302, 3, 7), (302, 6, 10), (304, 1, 3), (304, 2, 7), (304, 3, 9), (304, 4, 11), (304, 5, 14), (304, 6, 16), (306, 1, 4), (306, 5, 5), (308, 1, 5), (308, 2, 9), (308, 3, 12), (308, 4, 15), (308, 5, 16), (308, 6, 19), (310, 3, 7), (310, 5, 12), (310, 6, 14), (312, 1, 4), (312, 2, 6), (312, 3, 11), (312, 5, 13), (312, 6, 20), (314, 1, 3), (314, 2, 4), (314, 3, 6), (314, 4, 8), (314, 5, 9), (316, 1, 1), (316, 2, 3), (318, 3, 7), (318, 6, 60), (320, 1, 1), (320, 2, 3), (322, 1, 5), (322, 2, 8), (322, 3, 10), (322, 4, 13), (322, 5, 17), (322, 6, 19), (324, 3, 3), (324, 4, 6), (324, 5, 13), (324, 6, 16), (326, 1, 2), (326, 2, 4), (328, 2, 3), (328, 3, 4), (328, 6, 7), (330, 3, 7), (330, 5, 20), (330, 6, 27), (332, 1, 7), (332, 3, 12), (332, 4, 23), (332, 5, 32), (332, 6, 41), (334, 1, 2), (334, 2, 4), (334, 3, 5), (334, 6, 6), (336, 3, 3), (336, 5, 14), (336, 6, 22), (340, 3, 4), (340, 4, 6), (340, 5, 13), (340, 6, 17), (342, 1, 2), (342, 2, 8), (342, 3, 10), (342, 5, 13), (342, 6, 14), (344, 3, 4), (344, 5, 9), (344, 6, 11), (346, 1, 2), (346, 2, 3), (346, 3, 6), (346, 4, 10), (346, 5, 15), (348, 1, 1), (348, 2, 2), (348, 3, 3), (348, 6, 7), (350, 1, 20), (350, 2, 49), (350, 3, 62), (350, 5, 67), (350, 6, 68), (352, 1, 2), (352, 2, 6), (352, 3, 7), (352, 6, 11), (354, 3, 5), (354, 5, 8), (354, 6, 14), (358, 1, 5), (358, 2, 9), (358, 3, 11), (358, 5, 12), (362, 1, 1), (362, 2, 2), (362, 3, 3), (362, 4, 5), (362, 5, 6), (364, 2, 2), (364, 3, 3), (366, 1, 5), (366, 2, 10), (366, 3, 12), (366, 4, 18), (366, 5, 22), (368, 1, 3), (368, 2, 6), (368, 3, 8), (370, 1, 6), (370, 2, 7), (370, 3, 12), (372, 2, 1), (372, 3, 4), (374, 1, 1), (374, 2, 8), (374, 3, 12), (374, 5, 14), (376, 1, 7), (376, 2, 17), (376, 3, 20), (378, 1, 2), (378, 2, 4), (378, 3, 8), (378, 5, 13), (380, 1, 2), (380, 2, 11), (380, 3, 13), (384, 1, 5), (384, 2, 12), (384, 3, 15), (386, 1, 3), (386, 2, 10), (388, 1, 8), (388, 2, 15), (388, 3, 24), (388, 4, 25), (388, 5, 28), (390, 1, 3), (390, 3, 11), (390, 4, 14), (390, 5, 17), (394, 1, 1), (394, 3, 8), (394, 4, 9), (394, 5, 11), (396, 1, 4), (396, 2, 8), (396, 3, 11), (400, 1, 1), (400, 2, 2), (400, 3, 5), (400, 5, 6), (402, 3, 1), (402, 5, 3), (404, 1, 4), (404, 2, 15), (404, 3, 18), (406, 1, 2), (406, 2, 7), (406, 3, 9), (408, 1, 3), (408, 2, 5), (408, 3, 12), (408, 4, 21), (408, 5, 31), (410, 2, 3), (410, 3, 5), (412, 1, 6), (412, 2, 7), (412, 3, 12), (412, 5, 19), (414, 1, 6), (414, 2, 7), (414, 3, 14), (414, 5, 20), (418, 1, 3), (418, 2, 7), (418, 3, 11), (418, 5, 12), (420, 1, 2), (420, 2, 8), (420, 3, 10), (422, 1, 8), (422, 2, 10), (422, 4, 12), (422, 5, 14), (424, 2, 3), (424, 3, 5), (424, 4, 7), (424, 5, 10), (426, 3, 1), (426, 4, 2), (426, 5, 6), (428, 3, 3), (428, 4, 9), (428, 5, 18), (430, 3, 5), (430, 4, 7), (430, 5, 12), (432, 1, 2), (432, 2, 6), (432, 3, 10), (432, 5, 12), (434, 1, 6), (434, 2, 8), (434, 3, 11), (436, 2, 1), (436, 3, 2), (438, 1, 1), (438, 2, 4), (438, 3, 7), (440, 2, 1), (440, 3, 3), (440, 4, 4), (440, 5, 5), (442, 1, 1), (442, 2, 4), (442, 3, 8), (442, 5, 10), (444, 1, 1), (444, 2, 6), (444, 3, 7), (446, 3, 3), (446, 4, 6), (446, 5, 8), (448, 1, 3), (448, 2, 7), (448, 3, 14), (448, 5, 18), (450, 1, 3), (450, 2, 8), (450, 3, 10), (452, 1, 1), (452, 3, 8), (452, 4, 16), (452, 5, 23), (454, 2, 1), (454, 3, 2), (456, 2, 7), (456, 3, 8), (458, 1, 2), (458, 5, 4), (460, 1, 4), (460, 2, 7), (460, 3, 12), (460, 4, 14), (460, 5, 18), (462, 1, 3), (462, 2, 6), (462, 3, 8), (464, 1, 3), (464, 2, 6), (466, 1, 28), (466, 2, 30), (466, 3, 51), (466, 5, 53), (468, 3, 3),
         (468, 5, 8), (470, 1, 8), (470, 2, 18), (470, 3, 35), (470, 5, 46), (472, 1, 4), (472, 2, 8), (472, 3, 11), (474, 3, 6), (474, 5, 19), (476, 3, 4), 
         (476, 4, 7), (476, 5, 14), (478, 1, 3), (478, 3, 7), (478, 5, 11), (480, 1, 1), (480, 2, 9), (480, 3, 11), (482, 1, 5), (482, 2, 6), (482, 3, 12), 
         (484, 1, 4), (484, 2, 6), (484, 3, 8), (486, 1, 9), (486, 2, 15), (486, 3, 16), (486, 5, 24), (488, 3, 6), (488, 4, 8), (488, 5, 17), (490, 1, 4), 
         (490, 2, 14), (490, 3, 18), (492, 1, 4), (492, 3, 5), (492, 4, 6), (492, 5, 7), (494, 1, 4), (494, 2, 7), (494, 3, 11), (494, 5, 12), (496, 1, 1), (496, 3, 7), (496, 4, 12), (496, 5, 19), (498, 3, 4), (498, 4, 6), (498, 5, 8), (500, 1, 2), (500, 3, 6), (500, 4, 9), (500, 5, 11), (502, 1, 1), (502, 3, 5), (502, 5, 6), (506, 1, 2), (506, 2, 9), (506, 3, 11), (508, 1, 5), (508, 2, 14), (508, 3, 23), (508, 5, 25), (512, 3, 7), (512, 5, 10), (514, 1, 2), (514, 2, 3), (514, 3, 5), (514, 4, 7), (514, 5, 9), (516, 1, 2), (516, 2, 9), (516, 3, 10), (518, 3, 2), (518, 4, 3), (518, 5, 4), (520, 3, 4), (520, 4, 8), (520, 5, 12), (522, 3, 4), (522, 4, 7), (522, 5, 12), (526, 1, 3), (526, 2, 8), (526, 3, 11), (526, 5, 12), (530, 1, 3), (530, 2, 7), (530, 3, 10), (530, 5, 12), (534, 1, 4), (534, 2, 8), (534, 3, 13), (538, 1, 2), (538, 2, 3), (538, 4, 4), (538, 5, 5), (544, 1, 1), (544, 2, 3), (544, 3, 4), (546, 1, 4), (546, 2, 8), (546, 3, 9), (548, 1, 3), (548, 2, 5), (548, 3, 8), (550, 1, 3), (550, 2, 6), (550, 3, 12), (550, 4, 15), (550, 5, 17), (552, 1, 1), (552, 2, 4), (552, 3, 5), (554, 3, 3), (554, 5, 5), (556, 3, 12), (556, 5, 16), (558, 1, 2), (558, 2, 5), (558, 3, 8), (560, 3, 3), (560, 4, 4), (560, 5, 11), (562, 1, 1), (562, 2, 2), (562, 3, 4), (562, 4, 5), (564, 3, 5), (564, 4, 8), (564, 5, 11), (566, 2, 5), (566, 3, 9), (568, 1, 1), (568, 3, 6), (568, 5, 8), (570, 1, 2), (570, 2, 8), (570, 3, 9), (572, 2, 2), (572, 3, 6), (572, 5, 8), (574, 3, 8), (574, 5, 9), (578, 1, 3), (578, 3, 8), (578, 5, 12), (580, 4, 1), (580, 5, 7), (582, 1, 3), (582, 3, 8), (584, 1, 2), (584, 3, 7), (584, 5, 10), (588, 1, 3), (588, 2, 7), (590, 1, 1), (590, 2, 8), (590, 3, 10), (592, 3, 6), (592, 5, 13), (594, 3, 10), (594, 5, 11), (596, 1, 5), (596, 2, 7), (596, 3, 11), (596, 5, 12), (598, 1, 1), (598, 2, 4), (598, 3, 8), (600, 1, 2), (600, 2, 12), (600, 3, 15), (602, 1, 1), (602, 2, 2), (602, 3, 5), (602, 4, 7), (602, 5, 8), (604, 2, 3), (604, 3, 4), (606, 1, 3), (606, 2, 4), (606, 3, 23), (606, 4, 29), (606, 5, 42), (608, 1, 3), (608, 2, 10), (608, 3, 12), (610, 3, 4), (610, 4, 6), (610, 5, 10), (612, 1, 4), (612, 2, 7), (612, 3, 10), (612, 4, 13), (612, 5, 15), (614, 1, 4), (614, 2, 13), (614, 3, 15), (614, 5, 16), (616, 1, 4), (616, 2, 9), (616, 3, 14), (616, 5, 15), (618, 1, 4), (618, 2, 10), (618, 3, 17), (618, 5, 19), (620, 1, 2), (620, 4, 6), (620, 5, 9), (622, 1, 1), (622, 2, 3), (622, 3, 4), (624, 1, 4), (624, 2, 6), (624, 3, 10), (626, 3, 5), (626, 4, 12), (626, 5, 19), (628, 2, 4), (628, 3, 6), (630, 1, 4), (630, 2, 7), (630, 3, 14), (630, 5, 15), (632, 1, 1), (632, 3, 7), (632, 5, 15), (634, 1, 1), (634, 5, 14), (636, 3, 2), (636, 4, 7), (636, 5, 12), (638, 3, 2), (638, 4, 3), (638, 5, 5), (640, 1, 1), (640, 3, 2), (642, 1, 4), (642, 2, 8), (642, 3, 13), (642, 5, 15), (644, 1, 5), (644, 2, 7), (644, 3, 8), (644, 5, 9), (646, 1, 3), (646, 2, 8), (646, 3, 10), (646, 5, 11), (648, 1, 4), (648, 2, 7), (648, 3, 12), (648, 5, 13), (650, 1, 2), (650, 2, 4), (650, 3, 7), (650, 5, 8), (652, 1, 2), (652, 2, 9), (652, 3, 11), (654, 1, 2), (654, 2, 3), (654, 3, 4), (654, 4, 5), (654, 5, 6), (656, 1, 5), (656, 2, 8), (656, 3, 11), (656, 5, 13), (658, 1, 6), (658, 2, 10), (658, 3, 16), (662, 1, 1), (662, 2, 3), (662, 3, 4), (664, 3, 2), (664, 4, 3), (664, 5, 4), (666, 3, 6), (666, 5, 10), (668, 3, 5), (668, 4, 7), (668, 5, 8), (670, 1, 3), (670, 2, 9), (670, 3, 10), (672, 1, 5), (672, 2, 11), (672, 3, 13), (674, 1, 2), (674, 3, 7), (674, 5, 11), (676, 1, 3), (676, 2, 8), (676, 3, 23), (676, 4, 25), (676, 5, 33), (678, 3, 2), (678, 4, 5), (678, 5, 10), (680, 1, 1), (680, 2, 2), (680, 4, 6), (680, 5, 10), (682, 3, 9), (682, 4, 18), (682, 5, 22), (684, 1, 8), (684, 2, 18), (684, 3, 23), (684, 4, 30), (684, 5, 38), (686, 1, 9), (686, 2, 19), (686, 3, 31), (686, 4, 39), (686, 5, 47), (688, 1, 6), (688, 2, 14), (688, 3, 18), (688, 4, 21), (688, 5, 27), (690, 1, 2), (690, 3, 9), (692, 1, 3), (692, 2, 10), (692, 3, 14), (692, 5, 15), (694, 1, 1), (694, 2, 5), (694, 3, 7), (696, 1, 4), (696, 3, 11), (696, 5, 12), (698, 1, 2), (698, 2, 9), (698, 3, 11), (700, 3, 3), (700, 4, 9), (700, 5, 15), (702, 1, 2), (702, 2, 9), (702, 3, 11), (704, 1, 4), (704, 2, 14), (704, 3, 19), (704, 4, 21), (704, 5, 25), (706, 1, 3), (706, 2, 8), (706, 3, 10), (708, 1, 3), (708, 2, 7), (710, 1, 7), (710, 2, 13), (710, 3, 23), (710, 5, 28), (714, 1, 3), (714, 2, 12), (716, 1, 1), (716, 2, 4), (716, 3, 6), (718, 1, 4), (718, 2, 8), (718, 3, 10), (720, 3, 7), (720, 4, 11), (720, 5, 16), (722, 1, 3), (722, 3, 11), (722, 4, 12), (722, 5, 13), (724, 3, 9), (724, 4, 14), (724, 5, 23), (726, 3, 3), (726, 4, 5), (726, 5, 9), (728, 1, 4), (728, 2, 6), (728, 3, 8), (730, 1, 4), (730, 3, 7), (732, 1, 12), (732, 3, 14), (732, 5, 28), (734, 2, 6), (734, 3, 9), (736, 1, 3), (736, 2, 8), (736, 3, 12), (738, 1, 1), (738, 3, 7), (740, 1, 4), (740, 2, 13), (740, 3, 15), (742, 1, 2), (742, 2, 9), (742, 3, 14), (742, 5, 15), (744, 1, 1), (744, 2, 7), (744, 3, 8), (746, 3, 5), (746, 4, 6), (746, 5, 9), (750, 3, 5), (750, 5, 8), (754, 1, 2), (754, 2, 7), (754, 3, 10), (756, 1, 3), (756, 2, 5), (756, 3, 7), (758, 3, 1), (758, 4, 5), (758, 5, 6), (760, 1, 4), (760, 2, 13), (760, 3, 17), (762, 1, 5), (762, 2, 17), (762, 3, 33), (762, 5, 49), (764, 1, 2), (764, 2, 6), (764, 3, 8), (766, 1, 2), (766, 3, 9), (768, 2, 1), (768, 3, 3), (770, 1, 2), (770, 2, 8), (770, 3, 10), (770, 4, 15), (770, 5, 22), (772, 3, 8), (772, 4, 12), (772, 5, 16), (774, 1, 8), (774, 2, 10), (774, 3, 18), (774, 5, 23), (776, 1, 2), (776, 2, 6), (776, 3, 7), (776, 4, 14), (776, 5, 15), (778, 1, 3), (778, 2, 8), (778, 3, 15), (778, 5, 19), (780, 1, 3), (780, 2, 5), (780, 3, 7), (780, 4, 12), (780, 5, 17), (782, 2, 1), (782, 3, 2), (784, 4, 5), (784, 5, 8), (786, 1, 2), (786, 2, 9), (786, 3, 15), (786, 5, 16), (788, 1, 4), (788, 2, 6), (788, 3, 7), (788, 5, 20), (790, 1, 3), (790, 2, 9), (790, 3, 11), (792, 1, 4), (792, 2, 6), (792, 3, 9), (792, 4, 10), (792, 5, 14), (794, 2, 4), (794, 3, 5), (796, 1, 3), (796, 2, 7), (796, 3, 8), (798, 1, 1), (798, 2, 3), (800, 1, 2), (800, 2, 4), (800, 3, 5), (802, 2, 3), (802, 3, 4), (804, 1, 1), (804, 2, 2), (804, 3, 4), (804, 4, 5), (804, 5, 7), (806, 1, 4), (806, 3, 10), (806, 5, 12), (808, 1, 2), (808, 2, 4), (808, 3, 10), (810, 1, 8), (810, 3, 18), (810, 4, 29), (810, 5, 41), (812, 1, 10), (812, 3, 19), (812, 4, 31), (812, 5, 49), (814, 3, 4), (814, 4, 6), (814, 5, 8), (816, 1, 1), (816, 3, 2), (816, 4, 6), (816, 5, 10), (818, 3, 1), (818, 4, 4), (818, 5, 6), (820, 3, 9), (820, 4, 21), (820, 5, 31), (822, 1, 2), (822, 2, 4), (822, 3, 6), (824, 1, 1), (824, 3, 3), (824, 4, 5), (824, 5, 8), (826, 3, 2), (826, 4, 3), (826, 5, 5), (828, 1, 3), (828, 2, 12), (828, 3, 13), (828, 5, 15), (830, 1, 7), (830, 2, 11), (830, 3, 17), (830, 5, 23), (832, 1, 5), (832, 2, 9), (834, 1, 3), (834, 2, 10), (834, 3, 11), (834, 5, 12), (838, 1, 2), (838, 2, 5), (838, 5, 6), (842, 1, 14), (842, 2, 16), (842, 5, 24), (844, 1, 3), (844, 2, 4), (844, 5, 6), (846, 1, 1), (846, 2, 7), (848, 1, 1), (848, 2, 3), (850, 1, 2), (850, 2, 6), (852, 1, 4), (852, 2, 8), (852, 5, 10), (856, 1, 6), (856, 2, 8), (858, 1, 2), (858, 2, 6), (860, 1, 8), (860, 2, 10), (860, 5, 13), (866, 1, 1), (866, 2, 9), (868, 1, 3), (868, 2, 5), (870, 1, 1), (870, 2, 4), (872, 1, 3), (872, 2, 7), (874, 1, 3), (874, 2, 7), (876, 1, 2), (876, 2, 6), (878, 1, 4), (878, 2, 5), (878, 4, 7), (878, 5, 8), (880, 1, 1), (880, 2, 4), (884, 1, 2), (884, 2, 6), (886, 1, 4), (886, 2, 6), (888, 1, 4), (888, 2, 10), (890, 1, 3), (890, 2, 4), (892, 1, 2), (892, 2, 6), (894, 1, 1), (894, 2, 5), (896, 1, 3), (896, 2, 8), (896, 5, 9), (900, 1, 4), (900, 2, 8), (900, 5, 13), (902, 1, 1), (902, 2, 4), (902, 4, 5), (902, 5, 8), (904, 1, 6), (904, 2, 10), (904, 5, 12), (908, 1, 2), (908, 2, 3), (910, 1, 2), (910, 2, 8), (912, 1, 1), (912, 2, 3), (912, 5, 6), (914, 1, 5), (914, 2, 9), (914, 5, 23), (916, 4, 5), (916, 5, 9), (918, 1, 4), (918, 2, 10), (918, 5, 11), (920, 1, 1), (920, 2, 4), (922, 1, 2), (922, 4, 7), (922, 5, 8), (924, 1, 6), (924, 5, 7), (926, 1, 3), (926, 2, 9), (926, 4, 11), (926, 5, 12), (930, 1, 1), (930, 2, 3), (932, 2, 2), (932, 4, 3), (932, 5, 6), (934, 2, 4), (934, 4, 13), (934, 5, 17), (936, 1, 3), (936, 5, 9), (942, 1, 2), (942, 5, 3), (944, 1, 1), (944, 2, 2), (946, 1, 7), (946, 2, 10), (946, 5, 12), (948, 1, 1), (948, 4, 10), (948, 5, 21), (950, 1, 3), (950, 5, 11), (952, 1, 2), (952, 4, 5), (952, 5, 9), (954, 1, 1), (954, 4, 8), (954, 5, 27), (958, 1, 1), (958, 2, 5), (960, 1, 1), (960, 5, 8), (962, 1, 4), (962, 2, 9), (962, 5, 14), (964, 1, 2), (964, 5, 7), (966, 1, 4), (966, 5, 10), (968, 1, 1), (968, 5, 5), (970, 1, 6), (970, 2, 8), (970, 4, 9), (970, 5, 13), (972, 1, 1), (972, 2, 4), (974, 4, 5), (974, 5, 7), (976, 1, 4), (976, 2, 7), (976, 5, 11), (978, 1, 1), (978, 5, 3), (984, 1, 8), (984, 2, 12), (984, 5, 15), (986, 1, 6), (986, 2, 11), (986, 5, 13), (988, 1, 4), (988, 2, 9), (988, 4, 11), (988, 5, 15), (990, 1, 5), (990, 2, 11), (992, 1, 12), (992, 2, 16), (992, 4, 21), (992, 5, 33), (994, 1, 1), (994, 4, 2), (994, 5, 6), (996, 1, 5), (996, 2, 10), (996, 5, 12), (998, 1, 4), (998, 2, 8), (1000, 1, 1), (1000, 2, 4), (1002, 1, 3), (1002, 2, 9), (1004, 1, 2), (1004, 2, 6), (1004, 5, 12), (1008, 1, 6), (1008, 2, 12), (1008, 5, 15), (1010, 1, 5), (1010, 2, 8), (1010, 5, 12), (1012, 1, 4), (1012, 2, 9), (1014, 1, 3), (1014, 4, 5), (1014, 5, 8), (1016, 1, 3), (1016, 2, 6), (1016, 4, 10), (1016, 5, 11), (1018, 1, 5), (1018, 2, 8), (1018, 4, 10), (1018, 5, 13), (1020, 1, 5), (1020, 2, 6), (1020, 5, 12), (1022, 1, 5), (1022, 2, 10), (1022, 5, 13), (1024, 1, 1), (1024, 2, 6), (1026, 1, 4), (1026, 2, 9), (1026, 4, 12), (1026, 5, 15), (1028, 1, 3), (1028, 2, 7), (1028, 5, 8), (1030, 1, 4), (1030, 2, 6), (1030, 5, 8), (1032, 1, 5), (1032, 2, 12), (1032, 5, 13), (1038, 1, 3), (1038, 2, 6), (1038, 5, 8), (1040, 1, 3), (1040, 2, 7), (1040, 4, 8), (1040, 5, 10), (1042, 1, 2), (1042, 2, 5), (1044, 1, 2), 
         (1044, 2, 10), (1052, 1, 2), (1052, 5, 8), (1054, 1, 3), (1054, 2, 6), (1058, 1, 2), (1058, 2, 3), (1062, 1, 1), (1062, 5, 2), (1064, 1, 5), (1064, 2, 11), (1064, 5, 20), (1068, 1, 6), (1068, 2, 9), (1070, 1, 1), (1070, 2, 7), (1070, 4, 10), (1070, 5, 13), (1074, 1, 2), (1074, 2, 6), (1074, 4, 7), (1074, 5, 11), (1076, 1, 1), (1076, 2, 3), (1078, 1, 2), (1078, 2, 4), (1078, 4, 5), (1078, 5, 6), (1082, 1, 3), (1082, 2, 5), (1082, 5, 6), (1084, 1, 3), (1084, 2, 8), (1086, 1, 5), (1086, 5, 11), (1088, 1, 3), (1088, 2, 10), (1090, 1, 5), (1090, 5, 6), (1092, 1, 3), (1092, 2, 11), (1096, 1, 1), (1096, 2, 2), (1096, 4, 4), (1096, 5, 9), (1098, 1, 2), (1098, 2, 5), (1100, 1, 3), (1100, 2, 8), (1102, 1, 2), (1102, 5, 9), (1108, 1, 1), (1108, 2, 5), (1110, 1, 2), (1110, 2, 5), (1112, 1, 2), (1112, 2, 5), (1112, 4, 18), (1112, 5, 23), (1116, 1, 2), (1116, 2, 5), (1116, 4, 7), (1116, 5, 12), (1118, 1, 1), (1118, 4, 2), (1118, 5, 7), (1120, 1, 2), (1120, 2, 4), (1122, 1, 4), (1122, 2, 7), (1124, 1, 8), (1124, 2, 10), (1124, 4, 13), (1124, 5, 15), (1126, 1, 3), (1126, 5, 14), (1128, 1, 1), (1128, 2, 4), (1128, 4, 5), (1128, 5, 9), (1130, 1, 1), (1130, 2, 11), (1132, 1, 2), (1132, 2, 9), (1134, 1, 2), (1134, 2, 5), (1134, 5, 8), (1136, 1, 1), (1136, 5, 5), (1138, 1, 1), (1138, 2, 2), (1140, 1, 1), (1140, 5, 2), (1142, 1, 1), (1142, 4, 4), (1142, 5, 9), (1144, 1, 2), (1144, 2, 6), (1146, 1, 1), (1146, 2, 2), (1148, 4, 7), (1148, 5, 13), (1150, 1, 3), (1150, 5, 7), (1152, 1, 3), (1152, 2, 6), (1152, 4, 11), (1152, 5, 14), (1154, 1, 6), (1154, 2, 12), (1154, 4, 14), (1154, 5, 16), (1156, 1, 5), (1156, 4, 8), (1156, 5, 12), (1158, 1, 4), (1158, 2, 11), (1158, 4, 15), (1158, 5, 16), (1164, 2, 1), (1164, 4, 3), (1164, 5, 8), (1172, 1, 1), (1172, 2, 2), (1174, 4, 5), (1174, 5, 9), (1176, 4, 3), (1176, 5, 7), (1178, 1, 2), (1178, 2, 6), (1180, 1, 5), (1180, 2, 6), (1180, 4, 8), (1180, 5, 16), (1182, 1, 4), (1182, 2, 7), (1182, 5, 10), (1184, 1, 2), (1184, 2, 7), (1186, 2, 1), (1186, 4, 4), (1186, 5, 6), (1188, 4, 2), (1188, 5, 5), (1190, 1, 10), (1190, 2, 11), (1190, 5, 12), (1196, 1, 3), (1196, 4, 6), (1198, 1, 2), (1198, 2, 5), (1200, 1, 1), (1200, 2, 3), (1200, 4, 6), (1200, 5, 8), (1204, 1, 1), (1204, 4, 2), (1204, 5, 4), (1208, 4, 8), (1208, 5, 13), (1214, 1, 2), (1214, 2, 7), (1216, 1, 1), (1216, 2, 4), (1222, 1, 4), (1222, 2, 7), (1224, 1, 5), (1224, 2, 8), (1224, 5, 10), (1226, 1, 4), (1226, 2, 6), (1226, 5, 7), (1228, 1, 2), (1228, 4, 5), (1228, 5, 10), (1230, 1, 3), (1230, 2, 6), (1230, 4, 7), (1230, 5, 8), (1234, 1, 2), (1234, 5, 3), (1236, 1, 5), (1236, 2, 9), (1238, 1, 4), (1238, 4, 5), (1238, 5, 9), (1240, 1, 4), (1240, 2, 9), (1240, 5, 10), (1244, 1, 7), (1244, 2, 9), (1248, 1, 4), (1248, 2, 10), (1248, 5, 11), (1250, 1, 1), (1250, 5, 11), (1252, 1, 1), (1252, 2, 2), (1254, 1, 2), (1254, 2, 8), (1258, 1, 2), (1258, 5, 4), (1260, 1, 4), (1260, 5, 11), (1262, 1, 6), (1262, 2, 13), (1264, 1, 9), (1264, 5, 10), (1266, 1, 3), (1266, 2, 10), (1268, 1, 4), (1268, 2, 11), (1268, 5, 13), (1270, 1, 6), (1270, 2, 10), (1270, 4, 15), (1270, 5, 16), (1272, 1, 4), (1272, 2, 12), (1272, 4, 17), (1272, 5, 21), (1274, 1, 4), (1274, 2, 11), (1274, 5, 13), (1276, 1, 7), (1276, 2, 16), (1278, 1, 3), (1278, 4, 7), (1278, 5, 17), (1280, 1, 3), (1280, 2, 4), (1282, 1, 4), (1282, 2, 17), (1282, 5, 18), (1286, 4, 2), (1286, 5, 6), (1288, 1, 5), (1288, 2, 9), (1288, 4, 12), (1288, 5, 13), (1290, 1, 3), (1290, 2, 5), (1290, 5, 6), (1292, 1, 9), (1292, 2, 14), (1292, 5, 16), (1294, 1, 2), (1294, 2, 6), (1296, 1, 1), (1296, 2, 7), (1296, 5, 9), (1298, 1, 3), (1298, 2, 9), (1298, 4, 11), (1300, 1, 2), (1300, 2, 6), (1306, 1, 4), (1306, 2, 12), (1312, 1, 3), (1312, 2, 6), (1314, 1, 3), (1314, 2, 7), (1316, 4, 6), (1316, 5, 7), (1318, 1, 2), (1318, 2, 5), (1318, 5, 9), (1320, 1, 3), (1320, 2, 5), (1320, 5, 6), (1322, 1, 1), (1322, 2, 3), (1322, 4, 4), (1322, 5, 6), (1324, 1, 2), (1324, 2, 8), (1324, 5, 10), (1326, 1, 2), (1326, 2, 4), (1326, 5, 7), (1330, 1, 4), (1330, 4, 5), (1330, 5, 6), (1332, 1, 1), (1332, 2, 3), (1336, 1, 6), (1336, 5, 13), (1338, 1, 5), (1338, 2, 8), (1340, 1, 2), (1340, 2, 7), (1342, 1, 3), (1342, 4, 8), (1342, 5, 15), (1344, 1, 4), (1344, 2, 9), (1348, 1, 3), (1348, 5, 7), (1350, 1, 4), (1350, 2, 8), (1350, 4, 13), (1350, 5, 15), (1352, 1, 3), (1352, 2, 13), (1352, 4, 16), (1358, 1, 8), (1358, 2, 12), (1360, 1, 6), (1360, 2, 14), (1360, 5, 15), (1362, 1, 2), (1362, 2, 7), (1362, 5, 9), (1364, 1, 4), (1364, 2, 9), (1366, 4, 1), (1366, 5, 15), (1368, 2, 1), (1368, 4, 3), (1368, 5, 4), (1370, 1, 4), (1370, 5, 5), (1372, 1, 6), (1372, 2, 7), (1376, 1, 2), (1376, 5, 6), (1378, 1, 4), (1378, 5, 9), (1380, 1, 4), (1380, 2, 11), (1380, 5, 12), (1382, 1, 4), (1382, 2, 9), (1382, 5, 15), (1384, 1, 1), (1384, 2, 5), (1388, 1, 3), (1388, 4, 12), (1388, 5, 20), (1390, 1, 3), (1390, 2, 8), (1392, 1, 1), (1392, 2, 6), (1394, 1, 3), (1394, 2, 7), (1394, 5, 12), (1396, 1, 2), (1396, 2, 5), (1398, 1, 2), (1398, 2, 4), (1398, 4, 5), (1398, 5, 7), (1402, 1, 2), (1402, 2, 7), (1404, 1, 1), (1404, 2, 8), (1404, 5, 10), (1406, 1, 3), (1406, 2, 5), (1408, 1, 7), (1408, 2, 18), (1408, 3, 20), (1410, 1, 1), (1410, 2, 4), (1410, 4, 5), (1410, 5, 6), (1412, 1, 5), (1412, 2, 12), (1416, 1, 3), (1416, 5, 11), (1418, 1, 12), (1418, 2, 15), (1418, 5, 19), (1420, 1, 2), (1420, 5, 3), (1422, 1, 3), (1422, 5, 5), (1424, 1, 3), (1424, 5, 4), (1428, 1, 3), (1428, 2, 9), (1430, 1, 3), (1430, 5, 7), (1432, 1, 3), (1432, 2, 4), (1434, 1, 1), (1434, 2, 5), (1436, 1, 10), (1436, 2, 11), (1436, 5, 22), (1438, 1, 2), (1438, 2, 6), (1440, 1, 4), (1440, 2, 10), (1440, 5, 11), (1442, 1, 4), (1442, 2, 5), (1444, 2, 1), (1444, 5, 2), (1448, 1, 2), (1448, 2, 10), (1452, 1, 1), (1452, 2, 4), (1454, 1, 3), (1454, 2, 10), (1454, 4, 11), (1454, 5, 16), (1456, 1, 3), (1456, 2, 9), (1458, 1, 3), (1458, 2, 7), (1460, 2, 3), (1460, 4, 5), (1460, 5, 6), (1464, 1, 3), (1464, 2, 5), (1466, 1, 1), (1466, 5, 6), (1470, 1, 1), (1470, 2, 3), (1472, 1, 3), (1472, 5, 4), (1474, 1, 1), (1474, 2, 8), (1476, 1, 7), (1476, 2, 12), (1476, 5, 15), (1478, 1, 2), (1478, 2, 4), (1480, 1, 1), (1480, 2, 6), (1482, 1, 1), (1482, 2, 3), (1484, 1, 1), (1484, 5, 13), (1486, 1, 1), (1486, 2, 4), (1488, 1, 1), (1488, 2, 6), (1488, 4, 11), (1488, 5, 13), (1490, 1, 5), (1490, 2, 8), (1492, 1, 6), (1492, 2, 11), (1492, 5, 15), (1494, 1, 1), (1494, 2, 5), (1496, 1, 7), (1496, 2, 9), (1496, 4, 12), (1500, 1, 2), (1500, 5, 3)]
    gallery={k:v for (k,v) in embeddings.items() if not((k[0],k[1],k[2]) in J2)}
    query={k: v for (k,v)  in embeddings.items() if (k[0],k[1],k[2]) in J2 }

    
    print('Extracting features from gallery set ...')
    gf, g_pids, g_camids,g_trklets = _feature_extraction2(gallery.items()) 
    lg=g_pids,g_camids,g_trklets
    fg=gf   

    print('Done, obtained {}-by-{} matrix'.format(gf.shape[0], gf.shape[1])) 
    print('Extracting features from query set ...')
    qf, q_pids, q_camids,q_traklets_ = _feature_extraction2(query.items()) 
    lq=q_pids,q_camids,q_traklets_
    fq=qf
    print('Done, obtained {}-by-{} matrix'.format(qf.shape[0], qf.shape[1]))
    #print(seq)
    _writecsv1(lg,gf,lq,qf)

    print(len(query),'len_query')
    print(len(gallery),'len_gallery')

    
    gf,qf=torch.Tensor(gf),torch.Tensor(qf)
    distmat = compute_distance_matrix(qf, gf, dist_metric)
    distmat = distmat.numpy()
    if rerank:
        print('Applying person re-ranking ...')
        distmat_qq = compute_distance_matrix(qf, qf, dist_metric)
        distmat_gg = compute_distance_matrix(gf, gf, dist_metric)
        distmat = utils.re_ranking(distmat, distmat_qq, distmat_gg)

    print('Computing CMC and mAP ...')
    print(distmat.shape)

    cmc, mAP = eval_market1501(
            distmat,
            q_pids,
            g_pids,
            q_camids,
            g_camids,
            max_rank=50
        )
    print('** Results **')
    print('mAP: {:.3%}'.format(mAP))
    print('CMC curve')
    for r in ranks:
            print('Rank-{:<3}: {:.1%}'.format(r, cmc[r - 1]))    
            
    # if visrank:
    #         utils.visualize_ranked_results(
    #             distmat,
    #             self.datamanager.fetch_test_loaders(dataset_name),
    #             self.datamanager.data_type,
    #             width=self.datamanager.width,
    #             height=self.datamanager.height,
    #             save_dir=osp.join(save_dir, 'visrank_' + dataset_name),
    #             topk=visrank_topk
    #         )

    return cmc[0], mAP#, lg, fg , lq, fq   

def _evaluate_iLIDS(embeddings):
    print(len(embeddings))
    gallery={k:v for (k,v) in embeddings.items() if k[1]==2 }
    query={k:v for (k,v) in embeddings.items() if k[1]==1}
    
    
    qf,qpids,qcamids=_feature_extraction(query.items())
    gf,gpids,gcamids=_feature_extraction(gallery.items())
    lg=gpids,gcamids
    lq=qpids,qcamids
    _writecsv(lg,gf,lq,qf)
    # print(len(gallery),'len gallery')
    # print(len(query),"len query ")
    correct = 0.0
    total = 0.0
    
    gallery_embeddings = np.array(list(gallery.values()))
    gallery_targets = list(gallery.keys())
    

    probe_num = 0
    #print(len([query]))
    for probe in [query]:
        for (target, embedding) in probe.items():
            subject_id, probe_angle = target
            probe_pos = int(probe_angle)+1

            distance = np.linalg.norm(gallery_embeddings - embedding, ord=2, axis=1)
            min_pos = np.argmin(distance)
            min_target = gallery_targets[int(min_pos)]

            if min_target[0] == subject_id:
                correct += 1
            total += 1

            probe_num += 1
    print(probe_num)
    print(total)
    print(correct)
    accuracy = correct / total
    #accuracy -= np.diag(np.diag(accuracy))
    #accuracy_avg = np.mean(accuracy)
    return correct, accuracy
def _evaluate_casia_b(embeddings):
    """
    Test dataset consists of sequences of last 50 ids from CASIA B Dataset.
    Data is divided in the following way:
    Gallery Set:
        NM 1, NM 2, NM 3, NM 4
    Probe Set:
        Subset 1:
            NM 5, NM 6
         Subset 2:
            BG 1, BG 2
         Subset 3:
            CL 1, CL 2
    """

    gallery = {k: v for (k, v) in embeddings.items() if k[1] == 0 and k[2] <= 4}
    gallery_per_angle = {}
    for angle in range(0, 181, 18):
        gallery_per_angle[angle] = {k: v for (k, v) in gallery.items() if k[3] == angle}

    probe_nm = {k: v for (k, v) in embeddings.items() if k[1] == 0 and k[2] >= 5}
    probe_bg = {k: v for (k, v) in embeddings.items() if k[1] == 1}
    probe_cl = {k: v for (k, v) in embeddings.items() if k[1] == 2}

    correct = np.zeros((3, 11, 11))
    total = np.zeros((3, 11, 11))
    for gallery_angle in range(0, 181, 18):
        gallery_embeddings = np.array(list(gallery_per_angle[gallery_angle].values()))
        gallery_targets = list(gallery_per_angle[gallery_angle].keys())
        gallery_pos = int(gallery_angle / 18)

        probe_num = 0
        for probe in [probe_nm, probe_bg, probe_cl]:
            for (target, embedding) in probe.items():
                subject_id, _, _, probe_angle = target
                probe_pos = int(probe_angle / 18)

                distance = np.linalg.norm(gallery_embeddings - embedding, ord=2, axis=1)
                min_pos = np.argmin(distance)
                min_target = gallery_targets[int(min_pos)]

                if min_target[0] == subject_id:
                    correct[probe_num, gallery_pos, probe_pos] += 1
                total[probe_num, gallery_pos, probe_pos] += 1

            probe_num += 1

    accuracy = correct / total

    # Exclude same view
    for i in range(3):
        accuracy[i] -= np.diag(np.diag(accuracy[i]))

    accuracy_flat = np.sum(accuracy, 1) / 10

    header = ["NM#5-6", "BG#1-2", "CL#1-2"]

    accuracy_avg = np.mean(accuracy)
    sub_accuracies_avg = np.mean(accuracy_flat, 1)
    sub_accuracies = dict(zip(header, list(sub_accuracies_avg)))

    dataframe = pandas.DataFrame(
        np.concatenate((accuracy_flat, sub_accuracies_avg[..., np.newaxis]), 1),
        header,
        list(range(0, 181, 18)) + ["mean"],
    )

    return correct, accuracy_avg, sub_accuracies, dataframe


def evaluate(data_loader, model, evaluation_fn,log_interval=10, use_flip=False):
    model.eval()
    batch_time = AverageMeter()
    #print(seq)
    # Calculate embeddings
    with torch.no_grad():
        end = time.time()
        embeddings = dict()
        for idx, (points, target) in enumerate(data_loader):
            if use_flip:
                bsz = points.shape[0]
                data_flipped = torch.flip(points, dims=[1])
                points = torch.cat([points, data_flipped], dim=0)

            if torch.cuda.is_available():
                points = points.cuda(non_blocking=True)

            output = model(points)

            if use_flip:
                f1, f2 = torch.split(output, [bsz, bsz], dim=0)
                output = torch.mean(torch.stack([f1, f2]), dim=0)

            for i in range(output.shape[0]):
                sequence = tuple(
                    int(t[i]) if type(t[i]) is torch.Tensor else t[i] for t in target
                )
                embeddings[sequence] = output[i].cpu().numpy()

            batch_time.update(time.time() - end)
            end = time.time()

            if idx % log_interval == 0:
                print(
                    f"Test: [{idx}/{len(data_loader)}]\t"
                    f"Time {batch_time.val:.3f} ({batch_time.avg:.3f})\t"
                )
                sys.stdout.flush()
    return evaluation_fn(embeddings)


def main():
    import argparse

    parser = argparse.ArgumentParser(description="Evaluate model on dataset")
    parser.add_argument("dataset", choices=["casia-b","iLIDS","mars"])
    parser.add_argument("weights_path")
    parser.add_argument("data_path")
    parser.add_argument("--network_name", default="resgcn-n39-r8")
    parser.add_argument("--sequence_length", type=int, default=60)
    parser.add_argument("--batch_size", type=int, default=256)
    parser.add_argument("--embedding_layer_size", type=int, default=128)
    parser.add_argument("--use_multi_branch", action="store_true")
    parser.add_argument("--shuffle", action="store_true")
    parser.add_argument("--split_num", type=int, default=0)
    
    opt = parser.parse_args()
    print(opt)
    # Config for dataset
    graph = Graph("coco")
    dataset_class = dataset_factory(opt.dataset)
    evaluation_fn = None
    if opt.dataset == "casia-b":
        evaluation_fn = _evaluate_casia_b
    if opt.dataset == "iLIDS":
        evaluation_fn = _evaluate_iLIDS
    if opt.dataset == "mars":
        evaluation_fn = _evaluate_mars
    # Load data
    dataset = dataset_class(
        opt.data_path,
        train=False,
        sequence_length=opt.sequence_length,
        transform=transforms.Compose(
            [
                SelectSequenceCenter(opt.sequence_length),
                ShuffleSequence(opt.shuffle),
                MultiInput(graph.connect_joint, opt.use_multi_branch),
                ToTensor()
            ]
        ),
    )
    data_loader = DataLoader(dataset, batch_size=opt.batch_size)
    print(f"Data loaded: {len(data_loader)} batches")

    # Init model
    model, model_args = get_model_resgcn(graph, opt)

    if torch.cuda.is_available():
        model.cuda()
    #define a variable for seq lenght
    #seq=opt.sequence_length
    #print(seq)
    #time.sleep(60)
    # Load weights
    checkpoint = torch.load(opt.weights_path)
    model.load_state_dict(checkpoint["model"])
    if opt.dataset == "casia-b":
        
        result, accuracy_avg, sub_accuracies, dataframe = evaluate(
        data_loader, model, evaluation_fn, use_flip=True
    )
        print("\n")
        print((dataframe * 100).round(2))
        print(f"AVG: {accuracy_avg*100} %")
        print("=================================")
        print((dataframe * 100).round(1).to_latex())
        print((dataframe * 100).round(1).to_markdown())
    if opt.dataset == "iLIDS":
        result, accuracy_avg = evaluate(
        data_loader, model, evaluation_fn, use_flip=True
    )
    
        print("\n")
        
        print(f"AVG: {accuracy_avg*100} %")
        print("=================================")
    if opt.dataset == "mars":
        seq=opt.sequence_length
        print(seq,'######')
        result, accuracy_avg = evaluate(
        data_loader, model, evaluation_fn, use_flip=True)
    
        print("\n")
        
        print(f"mAP_mars: {accuracy_avg*100} %")
        print("=================================")   


if __name__ == "__main__":
    main()
